<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">

        <link rel="stylesheet" type="text/css" href="/public/css/normalize.css">
        <link rel="stylesheet" type="text/css" href="/public/css/styles.css">
        <link rel="stylesheet" type="text/css" href="/public/css/capture_styles.css">
        <title>Capture</title>
    </head>
    <body>

        <div id="main_container">
            <div id="workbench_container">
                <div id="requirements_list_container">
                    <div id="esp32_requirements_display" class="requirements_not_ready">ESP32</div>
                    <div id="esp32cam_requirements_display" class="requirements_not_ready">ESP32 Cam gurl!</div>
                    <div id="backend_requirements_display" class="requirements_not_ready">Backend</div>
                </div>
                <div id="capture_workbench">
                    <div id="capture_parameter_list">
                        <div class="capture_paramter_item">
                            <span class="capture_parameter_label">Step X</span>
            
                            <input type="range" min="1" max="180" value="1" class="slider" id="step_size_x_slider"
                                oninput="document.getElementById('step_size_x_banner').value = this.value;"
                            >
                            <input type="number" min="1" max="180" value="1"  class="capture_parameter_label capture_parameter_input" id="step_size_x_banner"
                                oninput = "document.getElementById('step_size_x_slider').value = this.value"
                            >
            
                            <span class="capture_parameter_unit_label"> °</span>
                        </div>
            
                        <div class="capture_paramter_item">
                            <span class="capture_parameter_label">Step Y</span>
            
                            <input type="range" min="1" max="20" value="1" class="slider" id="step_size_y_slider"
                                oninput="document.getElementById('step_size_y_banner').value = this.value;"
                            >
                            <input type="number" min="1" max="20" value="1"  class="capture_parameter_label capture_parameter_input" id="step_size_y_banner"
                                oninput = "document.getElementById('step_size_y_slider').value = this.value"
                            >
            
                            <span class="capture_parameter_unit_label">°</span>
                        </div>
                        <div class="capture_paramter_item">
                            <span class="capture_parameter_label">Medidas p. paso</span>
            
                            <input type="range" min="1" max="20" value="1" class="slider" id="measurements_per_step_slider"
                                oninput="document.getElementById('measurements_per_step_banner').value = this.value;"
                            >
                            <input type="number" min="1" max="20" value="1"  class="capture_parameter_label capture_parameter_input" id="measurements_per_step_banner"
                                oninput = "document.getElementById('measurements_per_step_slider').value = this.value"
                            >
            
                        </div>
            
                    </div>
                    <div class="separator"></div>
                    <div id="capture_console">
                        Console
                    </div>
                </div>
            </div>
            <!-- TODO: Acción -->
            <div id="capture_button">
                Comenzar Captura
            </div>
        </div>
    </body>
</html>

<script>
    function requestConnectionStatus() {
        let request = new XMLHttpRequest();
            request.open("GET", "/api/connection_status");
            request.onload = () => { 

                console.log(request.response);
                let json = JSON.parse(request.responseText)["status"];
                
                updateConnectionStatus(json["esp32"], json["esp32_cam"], json["backend"])
            }
        request.send();
    }

    function updateConnectionStatus(esp32_status, esp32_cam_status, backend_status) {
        displays = [
            [esp32_cam_status, "esp32cam_requirements_display"],
            [esp32_status    , "esp32_requirements_display"   ],
            [backend_status  , "backend_requirements_display" ],
        ]

        let every_ready = true;
        for (let elem of displays) {
            if (elem[0]["up"] && elem[0]["ready"]) {
                let display = document.getElementById(elem[1]);

                display.classList.add("requirements_ready");
                display.classList.remove("requirements_not_ready");
            } else {
                every_ready = false;
            }
        }

        let capture_button = document.getElementById("capture_button");
        if (!every_ready) {
            capture_button.style.cursor = "not-allowed";

            setTimeout(requestConnectionStatus, 2000);
        } else {
            capture_button.style.cursor = "pointer";    
        }
    }

    function onLoad() {
        window.top.document.title = "Capture";

        requestConnectionStatus();
    }
    onLoad();
</script>